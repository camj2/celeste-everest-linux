#!/bin/sh

API=https://dev.azure.com/EverestAPI/Everest/_apis/build/builds
API_VERSION=7.1

TMP="${XDG_RUNTIME_DIR:-/tmp}/celeste-everest-linux"

env_check() {
  for bin in jq awk sed curl unzip rsync; do
    if ! command -v "$bin" > /dev/null 2>&1; then
      printf "celeste-everest-linux: program '%s' not installed\n" "$bin" 1>&2
      exit 1
    fi
  done

  if [ ! -x Celeste ]; then
    printf "celeste-everest-linux: executable '%s/Celeste' not found\n" "$(pwd)" 1>&2
    exit 1
  fi

  if [ -e "$TMP" ]; then
    printf "celeste-everest-linux: directory '%s' already exists\n" "$TMP" 1>&2
    exit 1
  fi
}

azure_parse() {
  # https://github.com/leo60228/everinst/blob/master/src/updater.rs
  curl -s "${API}?api-version=${API_VERSION}" |
    jq -r '.value[] | select(
        (.status == "completed" and .result == "succeeded") and
        (.reason == "manual" or .reason == "individualCI")
      ) | (.id | tostring) + " " + (.sourceBranch | sub("refs/heads/"; ""))'
}

everest_install() {
  trap 'rm -rf "$TMP"; exit 1' HUP INT TERM

  install -d -m 700 "$TMP"

  curl -s -o "$TMP/everest.zip" \
    "${API}/${1}/artifacts?artifactName=main&api-version=${API_VERSION}&%24format=zip"

  unzip -q -d "$TMP/everest" "$TMP/everest.zip"

  rsync -aAX --checksum "$TMP/everest/main/" ./

  rm -rf "$TMP"

  chmod +x MiniInstaller-linux

  ./MiniInstaller-linux

  ln -s Celeste Celeste.bin.x86_64
}

everest_install_branch() {
  version=$(azure_parse | awk -v branch="$1" '$2 == branch {print $1; exit}')

  if [ -z "$version" ]; then
    printf "celeste-everest-linux: unable to parse Azure API\n" 1>&2
    exit 1
  fi

  everest_install "$version"
}

RST='\033[0;00m'
GRN='\033[0;32m'
GLD='\033[0;33m'

usage() {
  printf "%b\n" "${GLD}USAGE${RST}:"
  printf "%s\n" "    celeste-everest-linux [BRANCH]"
  printf "\n"
  printf "%b\n" "${GLD}BRANCHES${RST}:"
  printf "%b\n" "    ${GRN}s${RST}, ${GRN}stable${RST}"
  printf "%b\n" "    ${GRN}b${RST}, ${GRN}beta${RST}"
  printf "%b\n" "    ${GRN}d${RST}, ${GRN}dev${RST}"
}

case $1 in
  s | stable)
    env_check
    everest_install_branch stable
    ;;

  b | beta)
    env_check
    everest_install_branch beta
    ;;

  d | dev)
    env_check
    everest_install_branch dev
    ;;

  h | -h | help | --help | "")
    usage
    ;;

  *)
    printf "celeste-everest-linux: invalid branch -- '%s'\n" "$1" 1>&2
    exit 1
    ;;
esac
